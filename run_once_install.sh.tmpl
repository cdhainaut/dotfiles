#!/usr/bin/env bash
set -euo pipefail

# Options
: "${HEADLESS:=0}"   # HEADLESS=1 pour skipper les app GUI (wezterm)
export DEBIAN_FRONTEND=noninteractive
: "${TZ:=Europe/Paris}"    # force la timezone (override possible Ã  l'env)

log() { printf "\n\033[1;36m%s\033[0m\n" "ğŸ‘‰ $*"; }
ok()  { printf "\033[1;32m%s\033[0m\n" "âœ… $*"; }
skip(){ printf "\033[0;33m%s\033[0m\n"  "â­ï¸  $*"; }
need_cmd() { command -v "$1" >/dev/null 2>&1; }
in_docker() { [ -f /.dockerenv ] || grep -qa 'container=docker' /proc/1/environ 2>/dev/null; }

# sudo peut Ãªtre absent en conteneur minimaliste
SUDO="sudo"
need_cmd sudo || SUDO=""


log "Mise Ã  jour du systÃ¨me + prÃ©configuration tzdata ($TZ)"
$SUDO apt-get update -y
# prÃ©configure tzdata pour Ã©viter les prompts
echo "$TZ" | $SUDO tee /etc/timezone >/dev/null || true
$SUDO ln -sf "/usr/share/zoneinfo/$TZ" /etc/localtime || true
$SUDO apt-get install -y tzdata >/dev/null 2>&1 || true
$SUDO dpkg-reconfigure -f noninteractive tzdata >/dev/null 2>&1 || true

$SUDO apt-get upgrade -y

log "Paquets de base"
$SUDO apt-get install -y \
  build-essential curl git unzip ca-certificates pkg-config cmake ninja-build gettext \
  zsh ripgrep fzf fd-find bat eza plank

# Ubuntu: fd -> fdfind, bat -> batcat
if ! need_cmd fd && [ -x /usr/bin/fdfind ]; then
  $SUDO ln -sf /usr/bin/fdfind /usr/local/bin/fd
fi
if ! need_cmd bat && [ -x /usr/bin/batcat ]; then
  $SUDO ln -sf /usr/bin/batcat /usr/local/bin/bat
fi

### 1. Zsh + Oh My Zsh
if ! need_cmd zsh; then
  log "Installation de zsh"
  $SUDO apt-get install -y zsh
else
  ok "zsh dÃ©jÃ  installÃ©"
fi

if [ ! -d "$HOME/.oh-my-zsh" ]; then
  log "Installation de Oh My Zsh (unattended)"
  RUNZSH=no CHSH=no KEEP_ZSHRC=yes \
  sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
else
  ok "Oh My Zsh dÃ©jÃ  installÃ©"
fi

# DÃ©finir zsh comme shell par dÃ©faut si nÃ©cessaire (skip en conteneur)
if [ "${SHELL:-}" != "$(command -v zsh)" ]; then
  if in_docker; then
    skip "En conteneur: on ne change pas le shell (chsh demande un mot de passe/PAM)"
  else
    log "chsh vers zsh"
    chsh -s "$(command -v zsh)" || skip "Impossible de changer le shell (droits/PAM)"
  fi
else
  ok "zsh dÃ©jÃ  shell par dÃ©faut"
fi

### Neovim (branche stable)
if ! need_cmd nvim; then
  log "Installation de Neovim depuis les sources (branche stable)"
  rm -rf /tmp/neovim
  git clone --branch stable --depth 1 https://github.com/neovim/neovim.git /tmp/neovim
  ( cd /tmp/neovim && make CMAKE_BUILD_TYPE=Release && $SUDO make install )
  ok "Neovim installÃ©"
else
  ok "Neovim dÃ©jÃ  installÃ©"
fi

### 3. Rust & Cargo (prÃ©-requis pour zellij/helix/wezterm-build)
if ! need_cmd cargo; then
  log "Installation de Rust (rustup)"
  curl -fsSL https://sh.rustup.rs | sh -s -- -y --no-modify-path
  # shellcheck disable=SC1091
  source "$HOME/.cargo/env"
else
  ok "Rust/Cargo dÃ©jÃ  installÃ©s"
fi

### 4. zellij via cargo (plus frais que les paquets)
if ! need_cmd zellij; then
  log "Installation de zellij (cargo)"
  cargo install --locked zellij
else
  ok "zellij dÃ©jÃ  installÃ©"
fi

### 5. Helix depuis la source (runtime inclus)
if ! need_cmd hx; then
  log "Installation de Helix (source)"
  rm -rf /tmp/helix
  git clone --depth 1 https://github.com/helix-editor/helix.git /tmp/helix
  ( 
    cd /tmp/helix
    # mÃ©thode recommandÃ©e: build puis install binaire + runtime
    cargo install --path helix-term --locked
    $SUDO mkdir -p /usr/local/share/helix
    $SUDO rm -rf /usr/local/share/helix/runtime
    $SUDO cp -r runtime /usr/local/share/helix/
  )
  ok "Helix installÃ©"
else
  ok "Helix dÃ©jÃ  installÃ©"
fi

### 6. WezTerm (optionnel, skip en headless)
if [ "$HEADLESS" = "1" ]; then
  skip "HEADLESS=1 â†’ on skip WezTerm"
else
  if ! need_cmd wezterm; then
    log "Installation de WezTerm (paquet .deb officiel)"
    # âš ï¸ WezTerm est GUI, utile uniquement sur machine desktop.
    # MÃ©thode gÃ©nÃ©rique via .deb (peut nÃ©cessiter ajustement de version):
    tmpd=$(mktemp -d)
    cd "$tmpd"
    # Astuce: rÃ©cupÃ¨re la derniÃ¨re version stable via GitHub API si tu prÃ©fÃ¨res.
    # Ici on montre un placeholder. Remplace $DEB_URL par lâ€™URL exacte de la release.
    DEB_URL=""
    if [ -n "$DEB_URL" ]; then
      curl -fsSL "$DEB_URL" -o wezterm.deb
      $SUDO apt-get install -y ./wezterm.deb || $SUDO dpkg -i ./wezterm.deb || true
      $SUDO apt-get -f install -y
    else
      skip "Pas d'URL de release WezTerm renseignÃ©e â€” Ã  complÃ©ter."
    fi
  else
    ok "WezTerm dÃ©jÃ  installÃ©"
  fi
fi

### 7. Miniconda (zsh init)
if ! need_cmd conda; then
  log "Installation de Miniconda"
  curl -fsSL https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -o /tmp/miniconda.sh
  bash /tmp/miniconda.sh -b -p "$HOME/miniconda"

  # Initialise pour zsh (persistant)
  "$HOME/miniconda/bin/conda" init zsh || true

  # ğŸ‘‰ Rendez conda utilisable **dans cette session bash** (immÃ©diat, non-persistant)
  if [ -n "${BASH_VERSION:-}" ] && [ -x "$HOME/miniconda/bin/conda" ]; then
    eval "$("$HOME/miniconda/bin/conda" shell.bash hook)"
  elif [ -f "$HOME/miniconda/etc/profile.d/conda.sh" ]; then
    # fallback gÃ©nÃ©rique si conda hook indisponible
    # shellcheck disable=SC1091
    . "$HOME/miniconda/etc/profile.d/conda.sh"
  else
    export PATH="$HOME/miniconda/bin:$PATH"
  fi

  ok "Miniconda installÃ©"
else
  ok "Miniconda dÃ©jÃ  installÃ©"
fi

log "VÃ©rification versions"
ver() { printf '   - %s: %s\n' "$1" "${2:-}"; }

ver "zsh" "$(zsh --version 2>/dev/null || true)"
ver "oh-my-zsh" "$(test -d "$HOME/.oh-my-zsh" && echo present || echo absent)"
ver "nvim" "$(nvim --version 2>/dev/null | head -n1 || true)"
ver "rustc" "$(rustc --version 2>/dev/null || true)"
ver "cargo" "$(cargo --version 2>/dev/null || true)"
ver "zellij" "$(zellij --version 2>/dev/null || true)"
ver "hx" "$(hx --version 2>/dev/null || true)"
ver "fzf" "$(fzf --version 2>/dev/null || true)"
ver "fd" "$(fd --version 2>/dev/null || fdfind --version 2>/dev/null || true)"
ver "bat" "$(bat --version 2>/dev/null || batcat --version 2>/dev/null || true)"
ver "ripgrep" "$(rg --version 2>/dev/null | head -n1 || true)"
ver "plank" "$(plank --version 2>/dev/null || echo 'installed')"

if need_cmd wezterm; then
  ver "wezterm" "$(wezterm --version 2>/dev/null || true)"
else
  ver "wezterm" "skipped/headless"
fi

if need_cmd conda; then
  ver "conda" "$(conda --version 2>/dev/null || true)"
else
  ver "conda" "not in PATH (see Miniconda step)"
fi

ok "Stack de dÃ©veloppement installÃ©e avec succÃ¨s ğŸ‰"
